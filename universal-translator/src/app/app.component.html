<div class="container">
  <header>
    <h1>Universal Translator</h1>
    <div class="mode-selector">
      <label>
        <input type="checkbox" [checked]="isStreamingMode" (change)="toggleStreamingMode()">
        Streaming Mode
      </label>
      <span class="mode-description" *ngIf="isStreamingMode">
        Real-time streaming mode is active - translations will appear as you speak
      </span>
      <span class="mode-description" *ngIf="!isStreamingMode">
        Batch mode is active - translations will appear after you finish speaking
      </span>
      
      <!-- Connection status indicator -->
      <span *ngIf="isStreamingMode" class="connection-status" 
            [class.connected]="translationService.isWebSocketConnected()"
            [class.disconnected]="!translationService.isWebSocketConnected()">
        {{ translationService.isWebSocketConnected() ? 'Connected' : 'Disconnected' }}
      </span>
      
      <!-- New device selector button -->
      <button class="device-selector-btn" (click)="toggleDeviceSelector()">
        <i class="fa fa-cog"></i> Audio Devices
      </button>
    </div>
  </header>

  <main>
    <!-- WebSocket debug information (only visible when streaming mode is active) -->
    <div *ngIf="isStreamingMode" class="debug-panel">
      <div class="debug-info">
        <strong>WebSocket URL:</strong> {{ translationService.getWebSocketUrl() }}
      </div>
      <button (click)="reconnectWebSocket()" class="debug-btn">
        Reconnect WebSocket
      </button>
      <button (click)="testWebSocketConnection()" class="debug-btn">
        Test Connection
      </button>
    </div>

    <div class="translation-container">
      <div class="input-section">
        <h2>Input</h2>
        <textarea 
          [(ngModel)]="inputText" 
          placeholder="Enter text to translate..."
          [disabled]="isLoading"
          rows="5"
        ></textarea>
        
        <div class="actions">
          <button 
            (click)="translateText()" 
            [disabled]="isLoading || !inputText.trim()"
            class="translate-btn">
            Translate
          </button>
          
          <button 
            (click)="toggleRecording()" 
            [disabled]="isLoading || (isStreamingMode && !translationService.isWebSocketConnected())"
            [class.recording]="audioRecordingService.recording$ | async"
            class="record-btn">
            {{ (audioRecordingService.recording$ | async) ? 'Stop Recording' : 'Start Recording' }}
          </button>
        </div>
      </div>

      <div class="output-section">
        <h2>Translation</h2>
        <div class="translation-output" [class.loading]="isLoading">
          <div *ngIf="isLoading" class="loader"></div>
          <textarea 
            [value]="translatedText" 
            placeholder="Translation will appear here..."
            readonly
            rows="5"
          ></textarea>
        </div>

        <div class="audio-output" *ngIf="audioUrl">
          <h3>Generated Audio</h3>
          <audio #audioPlayer controls [src]="audioUrl">
            Your browser does not support the audio element.
          </audio>
        </div>
      </div>
    </div>

    <div *ngIf="isStreamingMode && streamedTranscriptions.length > 0" class="streaming-history">
      <h3>Streaming History</h3>
      <div class="streaming-entry" *ngFor="let entry of streamedTranscriptions; let i = index">
        <div *ngIf="entry.transcribed_text" class="transcription">
          <strong>Transcribed:</strong> {{ entry.transcribed_text }}
        </div>
        <div *ngIf="entry.translated_text" class="translation">
          <strong>Translated:</strong> {{ entry.translated_text }}
        </div>
        <hr *ngIf="i < streamedTranscriptions.length - 1">
      </div>
    </div>

    <div *ngIf="errorMessage" class="error-message">
      <p>{{ errorMessage }}</p>
      <button *ngIf="isStreamingMode && !translationService.isWebSocketConnected()" 
              (click)="reconnectWebSocket()" 
              class="reconnect-btn">
        Reconnect WebSocket
      </button>
    </div>
  </main>

  <!-- New device selector panel -->
  <div class="device-selector-panel" *ngIf="showDeviceSelector">
    <div class="device-row">
      <label for="microphone-select">Microphone:</label>
      <select id="microphone-select" [value]="selectedMicrophoneId" (change)="onMicrophoneChange($event)">
        <option *ngFor="let device of audioInputDevices" [value]="device.deviceId">
          {{ device.label || 'Microphone ' + (audioInputDevices.indexOf(device) + 1) }}
        </option>
      </select>
    </div>
    <div class="device-row">
      <label for="speaker-select">Speaker:</label>
      <select id="speaker-select" [value]="selectedSpeakerId" (change)="onSpeakerChange($event)">
        <option *ngFor="let device of audioOutputDevices" [value]="device.deviceId">
          {{ device.label || 'Speaker ' + (audioOutputDevices.indexOf(device) + 1) }}
        </option>
      </select>
    </div>
    <div class="device-info">
      <p *ngIf="audioInputDevices.length === 0">No microphones detected. Please check your connections.</p>
      <p *ngIf="audioOutputDevices.length === 0">No speakers detected. Please check your connections.</p>
      <p class="device-privacy-note">
        <small>Note: Speaker selection only works in Chrome, Edge, and Opera. Other browsers will use the system default.</small>
      </p>
      <p class="device-privacy-note">
        <small>If device names don't appear, you may need to grant persistent audio permission to this site.</small>
      </p>
    </div>
  </div>
</div>
